rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is the owner of a document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Helper function to validate email format
    function isValidEmail(email) {
      return email.matches('^[A-Za-z0-9._%+\\-]+@[A-Za-z0-9.\\-]+\\.[A-Za-z]{2,}$');
    }

    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated() && (
        isOwner(userId) ||
        isAdmin() ||
        // Any signed-in user can view approved trainers for listings.
        (resource.data.role == 'trainer' && resource.data.status == 'approved') ||
        // Trainers can view client profiles for trainer dashboards.
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'trainer'
      );
      allow create: if isAuthenticated() && isOwner(userId) &&
                   request.resource.data.keys().hasAll(['email', 'username', 'role']) &&
                   isValidEmail(request.resource.data.email) &&
                   request.resource.data.role in ['user', 'trainer', 'admin'];
      allow update, delete: if isAuthenticated() && (isOwner(userId) || isAdmin());
    }

    // Posts collection
    match /posts/{postId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
                    request.resource.data.keys().hasAll(['title', 'content', 'authorId']) &&
                    request.resource.data.title.size() > 0 &&
                    request.resource.data.title.size() <= 100 &&
                    request.resource.data.content.size() > 0 &&
                    isOwner(request.resource.data.authorId);
      
      allow update: if isAuthenticated() && 
                    isOwner(resource.data.authorId) &&
                    request.resource.data.title.size() > 0 &&
                    request.resource.data.title.size() <= 100 &&
                    request.resource.data.content.size() > 0;
      
      allow delete: if isAuthenticated() && isOwner(resource.data.authorId);
    }

    // Comments subcollection within posts
    match /posts/{postId}/comments/{commentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
                    request.resource.data.keys().hasAll(['content', 'authorId', 'authorName']) &&
                    request.resource.data.content.size() > 0 &&
                    request.resource.data.content.size() <= 1000 &&
                    isOwner(request.resource.data.authorId);
      
      allow update, delete: if isAuthenticated() && isOwner(resource.data.authorId);
    }

    // Workouts collection
    match /workouts/{workoutId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
                    get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['trainer', 'admin'] &&
                    request.resource.data.trainerId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
                            (resource.data.trainerId == request.auth.uid || isAdmin());
    }

    // Predefined plans (admin-managed)
    match /predefined_plans/{planId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }

    // Surveys collection
    match /surveys/{userId} {
      allow read: if isAuthenticated() && (isOwner(userId) || isAdmin() ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'trainer');
      allow create, update, delete: if isAuthenticated() && isOwner(userId);
    }

    // Fitness plans collection
    match /fitness_plans/{planId} {
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || isAdmin() ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'trainer');
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || isAdmin() ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'trainer');
    }

    // Plan progress collection (including subcollections)
    match /plan_progress/{userId}/{document=**} {
      allow read, write: if isAuthenticated() &&
        (isOwner(userId) || isAdmin() ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'trainer');
    }

    // Trainer requests collection
    match /trainer_requests/{requestId} {
      allow create: if isAuthenticated() &&
        (request.resource.data.clientId == request.auth.uid ||
          request.resource.data.userId == request.auth.uid);
      allow read: if isAuthenticated() &&
        (resource.data.clientId == request.auth.uid ||
          resource.data.trainerId == request.auth.uid ||
          isAdmin());
      allow update: if isAuthenticated() &&
        (resource.data.trainerId == request.auth.uid || isAdmin());
      allow delete: if isAuthenticated() &&
        (resource.data.clientId == request.auth.uid ||
          resource.data.trainerId == request.auth.uid ||
          isAdmin());
    }

    // User payments collection
    match /user_payments/{paymentId} {
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || isAdmin());
    }

    // Conversations collection
    match /conversations/{conversationId} {
      allow create: if isAuthenticated() &&
        request.resource.data.participants.hasAll([request.auth.uid]);
      allow read: if isAuthenticated() &&
        (resource == null || resource.data.participants.hasAny([request.auth.uid]));
      allow update, delete: if isAuthenticated() &&
        resource != null &&
        resource.data.participants.hasAny([request.auth.uid]);
    }

    // Messages collection root docs
    match /messages/{conversationId} {
      allow create: if isAuthenticated();
      allow read, update, delete: if isAuthenticated() &&
        get(/databases/$(database)/documents/conversations/$(conversationId))
          .data != null &&
        get(/databases/$(database)/documents/conversations/$(conversationId))
          .data.participants.hasAny([request.auth.uid]);

      // Messages subcollection
      match /texts/{messageId} {
        allow create: if isAuthenticated() &&
          request.resource.data.senderId == request.auth.uid &&
          get(/databases/$(database)/documents/conversations/$(conversationId))
            .data != null &&
          get(/databases/$(database)/documents/conversations/$(conversationId))
            .data.participants.hasAny([request.auth.uid]);
        allow read, update, delete: if isAuthenticated() &&
          get(/databases/$(database)/documents/conversations/$(conversationId))
            .data != null &&
          get(/databases/$(database)/documents/conversations/$(conversationId))
            .data.participants.hasAny([request.auth.uid]);
      }
    }

    // Public data that can be read by anyone but only written by admins
    match /public/{document=**} {
      allow read: if true;
      // Always evaluate to false - effectively disables write by default
      allow write: if request.time == timestamp(0, 0);
    }

    // Admin access rules
    match /admin/{document=**} {
      allow read, write: if isAuthenticated() &&
                         (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true ||
                          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }

    // Default deny all other operations
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
